#!/usr/bin/env sh

PROJECTS_DIR=$HOME/projects

# store the current dir
CUR_DIR=$(pwd)

if [ -z ${ACF_PRO_UPDATE_LICENSE+x} ]; then echo "Error: Please configure and export ACF_PRO_UPDATE_LICENSE environment variable.";  exit 1; fi


echo "upgrading all wordpress sites..."

cd $PROJECTS_DIR

# Find all git repositories
for i in $(find . -name ".git" | cut -c 3-); do
  #ignore submodules, vendor, composer,  and bins
  if [[ "$i" != *libraries*  && "$i" != *deployment*  && "$i" != *vendor* && "$i" != *bin* ]]
  then

    PROJECT_DIR=$(dirname $i)

    echo "checking $PROJECT_DIR...";

    #We have to go to the .git parent directory
    cd $PROJECT_DIR;


    if [ -e wp-config.php ]; then
      echo "found an install at $PROJECT_DIR"
      rm -rf autoupdate.log
      git checkout master --force
      git pull
      git branch -D update-wp
      git checkout -b update-wp
      wp eval 'acf_pro_update_license("${ACF_PRO_UPDATE_LICENSE}");'
      echo "\`\`\`" >> autoupdate.log
      echo "" >> autoupdate.log
      wp core update | sed '/^#/ d' >> autoupdate.log
      echo "\`\`\`" >> autoupdate.log
      echo "" >> autoupdate.log
      echo "\`\`\`" >> autoupdate.log
      echo "" >> autoupdate.log
      wp plugin update-all | sed '/^#/ d' >> autoupdate.log
      echo "\`\`\`" >> autoupdate.log
      echo "" >> autoupdate.log

      if [[ -z $(git status -s) ]]
      then
        echo "tree is clean"
      else
        git add -A
        cat autoupdate.log | sed '/^```/ d' | sed '/^$/d'  | git commit -F -
        git push -u origin update-wp
        gh pr create --title "Automatic Wordpress Updates" --body "$(cat autoupdate.log)"
      fi
    fi

    #lets get back to the PROJECTS_DIR and get more gits
    cd $PROJECTS_DIR
  fi
done

cd $CUR_DIR

echo "Complete!"
